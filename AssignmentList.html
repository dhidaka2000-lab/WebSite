<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>マイページ｜区域カード</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <style>
    [v-cloak] { display: none; }

    .loading {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(255,255,255,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }

    .cardno-badge {
      border: 2px solid #007bff;
      border-radius: 8px;
      padding: 2px 8px;
      font-weight: bold;
      margin-right: 6px;
    }

    #modalMap {
      width: 100%;
      height: 260px;
      border-radius: 8px;
    }
  </style>
</head>

<body class="bg-light">

<div class="loading" id="loading">
  <i class="fas fa-spinner fa-4x fa-spin"></i>
</div>

<main role="main" id="app" v-cloak class="container py-3">

<header class="sticky-top bg-white mb-2 py-2 border-bottom">
  <div class="d-flex justify-content-between align-items-center">

    <div class="d-flex gap-3">
      <button class="btn btn-link p-0 text-center" @click="go('mainMenu')">
        <div><i class="fas fa-arrow-circle-left fa-2x"></i></div>
        <div class="small">戻る</div>
      </button>
    </div>

    <div class="text-center flex-grow-1">
      <div style="font-size:22px; font-weight:700;">マイページ</div>
    </div>

    <div class="d-flex gap-3">
      <button class="btn btn-link p-0 text-center" @click="go('mainMenu')">
        <div><i class="fas fa-home fa-2x"></i></div>
        <div class="small">ホーム</div>
      </button>
    </div>

  </div>
</header>

<div class="alert alert-secondary py-2 mb-3">
  <strong>{{ userName }}</strong>（{{ userEmail }}）
  ／ グループ：{{ userGroup }} ／ 権限：{{ userrole }}
</div>

<div class="d-flex justify-content-end mb-2">
  <select class="form-select w-auto me-2" v-model="filterMode">
    <option value="all">全件表示</option>
    <option value="lent">貸出中のみ</option>
    <option value="focus">重点のみ</option>
    <option value="nonfocus">重点以外</option>
  </select>

  <button class="btn btn-primary" @click="refresh" :disabled="isUpdating">
    <i class="fas fa-sync-alt"></i> 最新情報に更新
  </button>
</div>

<div class="row g-3">
  <div class="col-12 col-sm-6 col-lg-6"
       v-for="child in filteredChilds"
       :key="child.CHILDID">

    <div class="card shadow-sm">
      <div class="card-body">

        <div class="d-flex justify-content-between">
          <h5 class="card-title mb-1">

            <!-- ★ COLOR に応じて塗り分け -->
            <span
              class="cardno-badge"
              :style="{
                background: colorMap[child.COLOR] || 'white',
                color: child.COLOR ? 'white' : '#007bff',
                borderColor: colorMap[child.COLOR] || '#007bff'
              }"
            >
              {{ child.CARDNO }}-{{ child.CHILDNO }}
            </span>

            {{ child.CHILDBLOCK }}
          </h5>

          <span class="badge" :class="statusClass(child)">
            {{ child.CHILDSTATUS }}
          </span>
        </div>

        <p class="text-muted mb-1">
          戸数：{{ child.CHILDHOUSES }}件（うち残 {{ child.CHILDHOUSES - child.VISITED }}件）
        </p>

        <p class="mb-2">
          <strong>使用期限：</strong> {{ child.CHILDLIMITDATE }}
        </p>

        <div class="d-flex gap-2">
          <button class="btn btn-sm btn-outline-primary w-50"
            @click="goToMap(child)">
            <i class="fa-solid fa-table-list"></i> カードを表示
          </button>

          <button class="btn btn-sm btn-outline-secondary w-50"
            @click="openModal('detail', child)">
            <i class="fas fa-info-circle"></i> 詳細
          </button>
        </div>

      </div>
    </div>

  </div>
</div>

<!-- ★ 詳細モーダル -->
<div class="modal fade" id="childModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">
          <span
            class="cardno-badge"
            :style="{
              background: colorMap[selectedChild?.COLOR] || 'white',
              color: selectedChild?.COLOR ? 'white' : '#007bff',
              borderColor: colorMap[selectedChild?.COLOR] || '#007bff'
            }"
          >
            {{ selectedChild?.CARDNO }}-{{ selectedChild?.CHILDNO }}
          </span>
          {{ selectedChild?.CHILDBLOCK }}
        </h5>
        <button type="button" class="btn-close" @click="closeModal"></button>
      </div>

      <div class="modal-body">

        <p><strong>貸出日：</strong> {{ selectedChild?.CHILDCHECKOUTDATE || "-" }}</p>
        <p><strong>使用開始日：</strong> {{ selectedChild?.CHILDSTARTDATE || "-" }}</p>
        <p><strong>使用期限：</strong> {{ selectedChild?.CHILDLIMITDATE || "-" }}</p>
        
        <p><strong>グループ：</strong> {{ selectedChild?.GROUP || "-" }}</p>
        <p><strong>グループ監督：</strong> {{ getUserName(selectedChild?.ARRENGER) }}</p>
        <p><strong>奉仕者：</strong> {{ getUserName(selectedChild?.MINISTER) }}</p>

        <p><strong>メモ：</strong> {{ selectedChild?.DESCRIPTION || "-" }}</p>

        <hr>

        <div id="modalMap"></div>

      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" @click="closeModal">閉じる</button>
      </div>

    </div>
  </div>
</div>

<div class="toast position-fixed bottom-0 end-0 m-3" id="updateToast">
  <div class="toast-header">
    <strong class="me-auto">更新完了</strong>
    <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
  </div>
  <div class="toast-body">
    最新のカード情報を取得しました。
  </div>
</div>

</main>

<script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBCib4rAXfXO_6nAiEO-VutN-FytgdnuvA",
    authDomain: "ekuikidev.firebaseapp.com",
    projectId: "ekuikidev",
  };
  firebase.initializeApp(firebaseConfig);
</script>

<script src="AssignmentList.js"></script>

</body>
</html>