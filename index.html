<script>
  const GAS_URL = "https://script.google.com/macros/s/AKfycbw9ONyKBLAzL_DunjAjsUPAmUQ3E3W2wwAvDw88eL6blTxpHR5_w-fOCLoOW1hw7a3r/exec";
  const CACHE_KEY = "childListCache";
  const CACHE_TTL = 5 * 60 * 1000; // 5分キャッシュ

  const metaEl = document.getElementById("meta");
  const tbody = document.querySelector("#items-table tbody");
  const errorEl = document.getElementById("error");

  async function loadData() {
    const cached = localStorage.getItem(CACHE_KEY);

    if (cached) {
      const cachedObj = JSON.parse(cached);
      const age = Date.now() - cachedObj.timestamp;

      if (age < CACHE_TTL) {
        console.log("Using cached data");
        renderTable(cachedObj.data);
        return;
      }
    }

    console.log("Fetching from GAS");

    fetch(GAS_URL)
      .then(response => response.json())   // ★ これでOK
      .then(data => {

        // キャッシュ保存
        localStorage.setItem(
          CACHE_KEY,
          JSON.stringify({ timestamp: Date.now(), data })
        );

        renderTable(data);
      })
      .catch(err => {
        errorEl.textContent = "Error: " + err.message;
      });
  }

  function renderTable(data) {
    metaEl.textContent = `status: ${data.status}, timestamp: ${data.timestamp}`;

    if (!Array.isArray(data.items)) {
      tbody.innerHTML = "<tr><td colspan='3'>items が配列ではありません</td></tr>";
      return;
    }

    tbody.innerHTML = "";
    data.items.forEach(item => {
      const tr = document.createElement("tr");

      tr.innerHTML = `
        <td>${item.CARDNO ?? ""}</td>
        <td>${item.CHILDNO ?? ""}</td>
        <td>${item.CHILDBLOCK ?? ""}</td>
      `;

      tbody.appendChild(tr);
    });
  }

  loadData();
</script>